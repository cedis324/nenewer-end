<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ì˜ˆì•½ ëª©ë¡(ê´€ë¦¬ì)</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="min-h-screen bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <div class="flex items-center justify-between">
            <a href="/" class="text-blue-600 hover:text-blue-500">â† ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
            <div class="space-x-3">
                <span class="text-sm font-semibold text-gray-900">ğŸ”§ ê´€ë¦¬ì í˜ì´ì§€</span>
            </div>
        </div>

        <div class="max-w-6xl mx-auto bg-white rounded-lg shadow mt-6">
            <div class="p-6 border-b">
                <h1 class="text-2xl font-bold">ê³µê°„ì˜ˆì•½ ê´€ë¦¬</h1>
                <p class="text-gray-500 text-sm mt-1">ëª¨ë“  ì˜ˆì•½ ë‚´ì—­(í™•ì •/ëŒ€ê¸°/ì·¨ì†Œ)ì„ ì¡°íšŒí•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•„í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ íŠ¹ì • ê³µê°„ì´ë‚˜ ë‚ ì§œë¥¼ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>

            <div class="p-6 space-y-4">
                <div class="grid grid-cols-3 gap-3">
                    <input id="adm-room" class="border rounded p-2" placeholder="ê³µê°„(ì˜ˆ: ROOM_A, ë¹„ìš°ë©´ ì „ì²´)" />
                    <input id="adm-date" type="date" class="border rounded p-2" />
                    <button id="adm-load" class="bg-gray-800 text-white py-2 rounded hover:bg-gray-700">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-3 py-2 text-left">ê³µê°„ID</th>
                                <th class="px-3 py-2 text-left">ë‚ ì§œ</th>
                                <th class="px-3 py-2 text-left">ì‹œê°„ëŒ€</th>
                                <th class="px-3 py-2 text-left">ìƒíƒœ</th>
                                <th class="px-3 py-2 text-left">í•™ë²ˆ</th>
                                <th class="px-3 py-2 text-left">ì´ë¦„</th>
                                <th class="px-3 py-2 text-left">ID</th>
                                <th class="px-3 py-2 text-left">ì¡°ì‘</th>
                            </tr>
                        </thead>
                        <tbody id="adm-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const room = document.getElementById("adm-room");
            const date = document.getElementById("adm-date");
            const load = document.getElementById("adm-load");
            const tbody = document.getElementById("adm-tbody");

            if (!date.value) {
                const t = new Date();
                const y = t.getFullYear();
                const m = String(t.getMonth() + 1).padStart(2, "0");
                const d = String(t.getDate()).padStart(2, "0");
                date.placeholder = `${y}-${m}-${d}`;
            }

            load.addEventListener("click", async () => {
                const q = new URLSearchParams();
                if (room.value) q.set("spaceId", room.value);
                if (date.value) q.set("date", date.value);

                const res = await fetch(`/api/reservations/all?${q}`);
                const json = await res.json();

                tbody.innerHTML = "";
                if (!json.ok || !json.data || json.data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="8" class="px-3 py-4 text-center text-gray-500">ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                    return;
                }

                json.data.forEach(item => {
                    const tr = document.createElement("tr");
                    tr.className = "border-b hover:bg-gray-50";
                    const statusBadge = item.status === "confirmed" ? `<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">í™•ì •</span>` :
                                       item.status === "waitlist" ? `<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs">ëŒ€ê¸°</span>` :
                                       `<span class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-xs">ì·¨ì†Œ</span>`;
                    tr.innerHTML = `
                        <td class="px-3 py-2">${item.spaceId || ""}</td>
                        <td class="px-3 py-2">${item.date || ""}</td>
                        <td class="px-3 py-2">${item.timeSlot || ""}</td>
                        <td class="px-3 py-2">${statusBadge}</td>
                        <td class="px-3 py-2">${item.studentId || ""}</td>
                        <td class="px-3 py-2">${item.studentName || ""}</td>
                        <td class="px-3 py-2 text-xs text-gray-500">${item._id || item.id || ""}</td>
                        <td class="px-3 py-2">
                            ${item.status !== "cancelled" ? `<button data-id="${item._id || item.id}" class="px-3 py-1 text-sm border border-red-300 text-red-600 rounded hover:bg-red-50">ì·¨ì†Œ</button>` : ""}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                [...tbody.querySelectorAll("button[data-id]")].forEach(btn => {
                    btn.addEventListener("click", async () => {
                        const id = btn.getAttribute("data-id");
                        if (!confirm("ì •ë§ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                        const res = await fetch(`/api/reservations/${id}`, { method: "DELETE" });
                        const json = await res.json();
                        if (!json.ok) {
                            alert("ì·¨ì†Œ ì‹¤íŒ¨: " + (json.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
                            return;
                        }
                        alert("ì·¨ì†Œ ì™„ë£Œ" + (json.promoted ? " (ëŒ€ê¸°ì—´ ìŠ¹ê²©ë¨)" : ""));
                        load.click();
                    });
                });
            });

            load.click();
        })();
    </script>
</body>
</html>
